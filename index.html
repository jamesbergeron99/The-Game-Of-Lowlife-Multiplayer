<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>The Game of Lowlife - Multiplayer</title>
<style>
  :root{--bg:#0b0b0e;--ink:#f5f5f7;--muted:#b7b7c2;--accent:#ffd54f;--border:#2a2a35;--card:#15161d}
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui, Arial, sans-serif;display:flex;flex-direction:column;min-height:100vh}
  header{display:flex;align-items:center;justify-content:center;gap:12px;padding:8px 14px;border-bottom:1px solid var(--border);background:#111}
  header img{max-height:72px;display:block}
  header h1{margin:0;font-weight:900;letter-spacing:1px;color:var(--accent)}
  #app{display:flex;flex-direction:column;flex:1;min-height:0}

  #topbar{flex:0 0 auto;position:sticky;top:0;z-index:50;background:var(--bg);border-bottom:1px solid var(--border)}
  #controls{max-width:1200px;margin:0 auto;padding:8px;display:flex;flex-wrap:wrap;gap:10px;align-items:center}
  .btn{background:#e53935;color:#fff;border:none;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer;transition:transform .1s}
  .btn:hover{background:#d32f2f}
  .btn:active{transform:scale(0.98)}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  input,select{background:#1b1b22;border:1px solid var(--border);color:#fff;border-radius:8px;padding:8px}
  label{color:var(--muted);font-size:.9rem}
  #status{color:var(--accent);min-width:280px}
  #gameInfo{color:var(--muted);font-size:.8rem;min-width:200px;}

  #spinnerWrap{display:flex;align-items:center;gap:8px;margin-left:auto}
  #spinner-container{position:relative;width:80px;height:80px}
  #spinner-wheel{position:absolute;inset:0;border-radius:50%;
    background:conic-gradient(#FF0000 0% 10%, #FF7F00 10% 20%, #FFFF00 20% 30%, #00FF00 30% 40%,#0000FF 40% 50%,#4B0082 50% 60%,#8B00FF 60% 70%,#FFC0CB 70% 80%,#F08080 80% 90%,#FFD700 90% 100%);
    box-shadow:0 0 12px rgba(0,0,0,.6);transform-origin:center center;transition:transform 4s cubic-bezier(.25,.46,.45,.94)}
  #arrow{position:absolute;top:-6px;left:50%;transform:translateX(-50%);width:0;height:0;border-left:6px solid transparent;border-right:6px solid transparent;border-bottom:12px solid #fff;z-index:5}
  #spinBtn{min-width:100px}

  #main{display:flex;flex-direction:column;flex:1;min-height:0}
  #boardArea{flex:1;min-height:0;overflow:auto}
  #track{max-width:1200px;margin:8px auto;display:grid;grid-template-columns:repeat(20,1fr);gap:4px;position:relative}
  .cell{min-height:44px;border:1px solid var(--border);background:#202028;color:#ddd;font-size:.7rem;display:flex;align-items:center;justify-content:center;text-align:center;border-radius:8px;padding:3px;position:relative}
  .cell small{display:block;color:#cfcfcf;font-size:.6rem;margin-top:2px}
  .cell.start{background:#1b5e20}
  .cell.finish{background:#0d47a1}
  .cell.payday{background:#2e7d32;color:#fff;font-weight:800}
  .cell.tard{background:#5a189a}
  .cell.bankruptcy{background:#b71c1c}
  .cell.lottery{background:#795548}
  .cell.idtheft{background:#263238}
  .cell.extortion{background:#4e342e}
  .cell.active{outline:3px dashed #ffd54f}

  .tokens{position:absolute;inset:2px;display:flex;flex-wrap:wrap;gap:2px;align-content:flex-start;justify-content:flex-start;pointer-events:none}
  .token{width:14px;height:14px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:900;color:#000;text-shadow:0 0 2px #fff;border:1px solid rgba(0,0,0,.4)}

  #playersDock{flex:0 0 170px;border-top:1px solid var(--border);background:#0e0e12}
  #players{height:100%;max-width:1200px;margin:0 auto;padding:8px;display:flex;gap:12px;overflow-x:auto}
  .card{min-width:260px;background:var(--card);border:1px solid var(--border);border-radius:12px;padding:10px;transition:all .3s ease}
  .card.is-current-turn{outline:3px solid #ffd54f;box-shadow:0 0 15px rgba(255, 213, 79, 0.5);}
  .title{font-weight:900;margin-bottom:6px}
  .mono{font-variant-numeric:tabular-nums}
  .delta{font-size:.8rem;color:#9ccc65;margin-left:6px}
  .user-id{font-size:.7rem;color:#555;}

  #modal{display:none;position:fixed;inset:0;align-items:center;justify-content:center;background:rgba(0,0,0,.8);z-index:100;}
  #modal .sheet{background:#181921;border:1px solid #2a2a35;border-radius:12px;max-width:560px;width:92%;padding:16px;}
</style>
</head>
<body>
<header>
  <img id="logo" src="lowlife logo.jpg" alt="The Game of Lowlife">
  <h1>The Game of Lowlife</h1>
</header>

<div id="app">
  <section id="topbar">
    <div id="controls">
      <label>Game ID:
        <input type="text" id="gameIdInput" placeholder="Enter a Game ID" maxlength="20"/>
      </label>
      <button id="joinGameBtn" class="btn">Join/Create Game</button>
      <button id="startGameBtn" class="btn" disabled style="background:#4caf50;">Start Game</button>
      <button id="spinBtn" class="btn" disabled>SPIN</button>
      <label>Voice: <select id="voiceSel"></select></label>
      <span style="color:#aaa">TARD deck: <span id="deckCount">N/A</span></span>
      <span id="gameInfo"></span>
      <span id="status">Connecting to server...</span>
      <div id="spinnerWrap" title="Spin result is read aloud">
        <div id="spinner-container">
          <div id="spinner-wheel"></div>
          <div id="arrow"></div>
        </div>
      </div>
    </div>
  </section>

  <section id="main">
    <section id="boardArea">
      <div id="track"></div>
    </section>
    <section id="playersDock">
      <div id="players"></div>
    </section>
  </section>
</div>

<div id="modal">
  <div class="sheet">
    <h3 id="modalTitle">TARD CARD</h3>
    <div id="modalBody" class="body" style="white-space:pre-wrap;line-height:1.4"></div>
    <div id="modalActions" class="actions" style="margin-top:12px;text-align:right">
      <button class="btn" onclick="window.closeModal()">OK</button>
    </div>
  </div>
</div>

<script>
// ===== CONSTANTS =====
const CHARACTERS = [
  { name:'Slum Lord',         payday:2500, edu:'High School', paysOff:['Pornstar'] },
  { name:'Gold Digger',       payday:2000, edu:'Dropout',     paysOff:['Porn Producer'], rentImmunityOnLanding:true },
  { name:'Pimp',              payday:7000, edu:'High School', paysOff:['Dirty Cop'] },
  { name:'Drug Dealer',       payday:2500, edu:'Dropout',     paysOff:[] },
  { name:'Pornstar',          payday:2000, edu:'Dropout',     paysOff:['Pimp'] },
  { name:'Porn Producer',     payday:2500, edu:'High School', paysOff:['Gold Digger'] },
  { name:'Online Influencer', payday:2000, edu:'Dropout',     paysOff:['Dirty Cop'] },
  { name:'Dirty Cop',         payday:2500, edu:'High School', paysOff:[] }
];
const EVENTS = [
  'Start','High school pregnancy, gain a family member','Sell weed at school, earn $500','Tard card','Payday','Breast implant bursts, pay $500 for surgery','Mom gets fired from the brothel, gain a family member','Identity theft','Waiting for dealer, miss a turn','Tard card','Payday','High on K, fall back two spaces','Pick a pocket, earn $200','Add to shit mix','Tard card','Bankruptcy, spin a five or nine to avoid financial ruin','Got fired as porn fluffer, miss next payday','Payday','Pay back payday loan, $600','Tard card','Extortion','Identity theft','Wake up and need stitches in your head, miss a turn','Drink the shit mix','Add to shit mix','Payday','Accidentally poison your spouse, lose a family member','Extortion','Dine and dash, earn $100','Lottery, spin three or nine to win','Payday','Tard card','Got a father\'s day abortion, lose a family member','Identity theft','Get laid off on your birthday, miss your next payday, do a shot','Gerbiling incident, pay $1,000 for removal','Payday','Shotgun wedding, gain a family member','Lottery, spin four or eight to win','Crazy brother won\'t leave, gain a family member','Tard card','Your TikTok goes viral, spin times 100','Get a massage with a happy ending, pay $300','Extortion','Ha ha, it\'s twins, gain a family member, times two','Payday','Feeling a bit tipsy, stumble forward one space','Bankruptcy, spin a three to avoid total ruin','Tard card','Get work as dildo tester, earn $1,000','Get a payday loan, earn $200','Fly to Thailand to get a vagina installed, pay $1,000','Family delousing, pay 500 per member','Payday','Lottery, spin a one to win','Bankruptcy, you\'re fucked','Identity theft','Tard card','Lost a kid at the mall, lose a family member','Got a part-time job as a porn fluffer, spin times 100','Payday','Drink the shit mix','Steal $1,000 from any player','Tard card','Extortion','Payday','Go back three spaces to look for phone','Lottery, spin a one or nine to win','Surprise! I\'m your kid. Gain a family member.','Identity theft','Sell used sex toys online. Spin x 50.','Tard card','Buy used sex toys online. Pay $300.','Payday','Arrested in the Dominican. Pay $5,000.','High on meth. Speed ahead two places.','Tard card','Bankruptcy. Spin 9 to avoid total ruin.',
  'Payday','Tard card','Identity theft','Extortion','Lottery, spin two or eight to win','Got caught on camera shoplifting, pay $400','Found cash in a Crown Royal bag, earn $350','Bachelor party side hustle, earn $700','Baby mama drama, lose a family member','Neighborhood brawl goes viral, spin times 100','Rent\'s due, pay $500','OnlyFans flop, pay $300 for lighting','Win a radio contest, earn $250','Stuck in detox, miss a turn','Payday','Tard card','Speed date disaster, go back three spaces','Hot streak at the slots, earn $1,000','High on shrooms, stumble forward one space',
  'Bankruptcy — instant, no rescue.',
  'Finish — first to cross gets $10,000 bonus.'
];
const N_SQUARES = EVENTS.length;
const FINISH_BONUS = 10000;

const TARD_CARDS = [
  'Grandma Joined a Cult – She ran off with a man named Moonbeam. Lose 1 family member.',
  'Dad Arrested in the Dominican Republic – “It was just one drink!” Lose 1 family member.',
  'Brother ODs – The good die young, the dumb die first. Lose 1 family member.',
  'DNA Disaster – Turns out you’re not the dad. Lose 1 family member.',
  'Family Car Fire – Somebody lit up while pumping gas. Lose 1 family member.',
  'Mom Gets Fired from the Brothel – She’s moving in. Gain 1 family member.',
  'Meth Lab Explosion – Dad survived and needs a couch. Gain 1 family member.',
  'Queer Cousin Gets Thrown Out – Glitter storm incoming. Gain 1 family member.',
  'Surprise! You’re My Real Dad – Someone’s calling you “Daddy,” and not the fun kind. Gain 1 family member.',
  'Bro Just Got Released – Fresh out and already asking for Wi-Fi. Gain 1 family member.',
  'Karma’s Bitch – Reverse any money loss.',
  'Block Their Blessing – Cancel another player’s money/bonus and take it.',
  'Public Humiliation – Force them to do the same dare or pay.',
  'Take the Couch – Swap one family member between you and them.',
  'Petty AF – Skip the next turn of whoever made you lose yours.',
  'Scabies Breakout – Pay $200 per family member to get deloused.',
  'Sing Us a Song – $500 bonus if recorded.',
  'Update Facebook: “I WON THE LOTTERY!”',
  'Make the Person to Your Left Laugh – Fail? Pay $100.',
  'Share Your Most Embarrassing Moment – Earn $200 if everyone cringes.',
  'Eat a Red Chili Pepper – Survive a full turn without water to gain $500.',
  'Give Your Neighbor a Pearl Necklace.',
  'Draw Your Best Cocksucker Lips in 5 Seconds.',
  'Give Someone a Lap Dance – Collect $100 per blush.',
  'Bad Trip – Woke up in another province. Lose a turn.',
  'Repo Man – Lose your vehicle or pay $500.',
  'Tax Refund Gone Wrong – Lose $1,000.',
  'OnlyFans Fame – Gain $1,500, lose your job.',
  'Evangelical Exorcism – Lose $200.',
  'Public Urination Ticket – Lose $300.',
  'Drag Bingo Win – Gain $300.',
  'Bad Investment – Lose $1,500.',
  'Power Outage Party – Gain one social connection and $100.',
  'STD Scare – Lose a turn.',
  'Eviction Notice – Move back home. Gain 1 family member.',
  'Payoff Card – Pay the person on your character card. Spin x 50.',
  'Payoff Card – Pay the person on your character card. Spin x 50.',
  'Payoff Card – Pay the person on your character card. Spin x 50.',
  'Payoff Card – Pay the person on your character card. Spin x 50.',
  'Payoff Card – Pay the person on your character card. Spin x 50.',
  'Payoff Card – Pay the person on your character card. Spin x 50.',
  'Payoff Card – Pay the person on your character card. Spin x 50.',
  'Payoff Card – Pay the person on your character card. Spin x 50.',
  'Payoff Card – Pay the person on your character card. Spin x 50.',
  'Payoff Card – Pay the person on your character card. Spin x 50.'
];

// ===== STATE =====
let localGameState = { state:'LOBBY', turn:null, players:{}, firstFinisherAwarded:false };
let localPlayer = null;
let ws = null;
let playerId = null;
let currentAngle = 0;
let spinning = false;
let voices=[], chosenVoice=null, speechQueue=[], speaking=false;

const gameIdInput = document.getElementById('gameIdInput');
const joinGameBtn = document.getElementById('joinGameBtn');
const startGameBtn = document.getElementById('startGameBtn');
const spinBtn = document.getElementById('spinBtn');
const statusEl = document.getElementById('status');
const gameInfoEl = document.getElementById('gameInfo');
const playersEl = document.getElementById('players');
const boardEl = document.getElementById('track');
const deckCountEl = document.getElementById('deckCount');
const wheel = document.getElementById('spinner-wheel');

function queueSay(text){
  if(!('speechSynthesis' in window)||!text) return;
  speechQueue.push(text);
  if(!speaking) playNextUtterance();
}
function playNextUtterance(){
  if(speechQueue.length===0){ speaking=false; return; }
  speaking=true;
  const utt=new SpeechSynthesisUtterance(speechQueue.shift());
  if(chosenVoice) utt.voice=chosenVoice;
  utt.onend=()=>playNextUtterance();
  try{ speechSynthesis.speak(utt);}catch(e){speaking=false;}
}
function populateVoices(){
  voices=speechSynthesis.getVoices()||[];
  voiceSel.innerHTML='';
  if(voices.length===0){ voiceSel.innerHTML='<option>(no voices)</option>'; chosenVoice=null; return; }
  voices.forEach((v,i)=>{ const opt=document.createElement('option'); opt.value=i; opt.textContent=`${v.name} — ${v.lang}`; voiceSel.appendChild(opt); });
  const idx=voices.findIndex(v=>/UK|British/i.test(v.name+v.lang)&&/en/i.test(v.lang));
  voiceSel.selectedIndex=idx>=0?idx:0;
  chosenVoice=voices[voiceSel.selectedIndex]||null;
}
if('speechSynthesis' in window){ populateVoices(); window.speechSynthesis.onvoiceschanged=populateVoices; }

function connectWS(){
  ws=new WebSocket("wss://lowlife-server-2.onrender.com");
  ws.onopen=()=>{
    statusEl.textContent="Connected to server. Enter Game ID.";
    joinGameBtn.disabled=false;
  };
  ws.onmessage=e=>{
    const msg=JSON.parse(e.data);
    handleServerMessage(msg);
  };
  ws.onclose=()=>{ statusEl.textContent="Disconnected; refresh to reconnect."; joinGameBtn.disabled=true; startGameBtn.disabled=true; spinBtn.disabled=true; };
}
function send(msg){ if(ws&&ws.readyState===WebSocket.OPEN) ws.send(JSON.stringify(msg)); }

joinGameBtn.onclick=()=>{ send({type:"joinGame", gameId:gameIdInput.value.trim(), playerName:gameIdInput.value.trim()||"Player"}); };
startGameBtn.onclick=()=>{ send({type:"startGame", gameId:gameIdInput.value.trim()}); };
spinBtn.onclick=()=>{ if(localGameState.turn===playerId&&!spinning){ send({type:"spin", gameId:gameIdInput.value.trim(), playerId:playerId}); } };

function handleServerMessage(data){
  if(data.type==="gameCreated"){
    gameIdInput.value=data.gameId;
    statusEl.textContent=`Game created. ID: ${data.gameId}`;
  }
  if(data.type==="playerList"){
    localGameState.players=data.players;
    renderPlayers(); renderBoard();
  }
  if(data.type==="gameStarted"){
    localGameState.players=data.players;
    localGameState.turn=data.turn;
    playerId = window.currentPlayerId = data.turn;
    statusEl.textContent=`Game started — turn: ${data.turn}`;
    renderPlayers(); renderBoard();
  }
  if(data.type==="gameState"){
    localGameState.players=data.players;
    localGameState.turn=data.turn;
    statusEl.textContent=`Turn: ${data.turn}`;
    renderPlayers(); renderBoard();
  }
}

function renderBoard(){
  if(boardEl.childElementCount===0){
    for(let i=0;i<N_SQUARES;i++){
      const text=EVENTS[i];
      const kind=classify(text);
      const c=document.createElement('div');
      c.className='cell '+(kind==='normal'?'':kind);
      c.dataset.index=i;
      c.title=text;
      c.innerHTML=`<div><b>${i+1}</b><small>${shortLabel(text)}</small></div><div class="tokens"></div>`;
      boardEl.appendChild(c);
    }
  }
  placeAllTokens();
  highlightCell(localPlayer?localPlayer.position:-1);
}

function highlightCell(idx){
  document.querySelectorAll('.cell').forEach(e=>e.classList.remove('active'));
  const el=document.querySelector(`.cell[data-index="${idx}"]`);
  if(el) el.classList.add('active');
}

function placeAllTokens(){
  document.querySelectorAll('.tokens').forEach(t=>t.innerHTML='');
  for(const p of Object.values(localGameState.players)){
    const cell=document.querySelector(`.cell[data-index="${p.position}"] .tokens`);
    if(cell){
      const el=document.createElement('div');
      el.className='token';
      el.style.background=p.color;
      el.textContent=initials(p.name);
      cell.appendChild(el);
    }
  }
}

function renderPlayers(){
  playersEl.innerHTML='';
  const players = Object.values(localGameState.players);
  const sorted = players; // no custom order
  for(const p of sorted){
    const d=document.createElement('div');
    d.className='card';
    if(p.id===localGameState.turn) d.classList.add('is-current-turn');
    d.innerHTML=`<div class="title"><span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:${p.color};margin-right:6px"></span>${p.name}</div>
      <div class="user-id">ID: ${p.id.slice(0,8)}...</div>
      <div>Char: ${p.character.name} | Edu: ${p.character.edu}</div>
      <div>Payday: <span class="mono">$${p.character.payday.toLocaleString()}</span></div>
      <div>Money: <span class="mono">$${p.money.toLocaleString()}</span> | Family: <span class="mono">${p.family}</span><span class="delta">${p.lastMoneyDelta?`(${p.lastMoneyDelta>0?'+':''}${p.lastMoneyDelta})`:''}</span></div>
      <div>Pos: <span class="mono">#${p.position+1}</span> — ${EVENTS[p.position]}</div>`;
    playersEl.appendChild(d);
  }
}

function classify(text){
  const t=text.toLowerCase();
  if(t.startsWith('start')) return 'start';
  if(t.startsWith('finish')) return 'finish';
  if(t.includes('payday')) return 'payday';
  if(t.includes('tard card')) return 'tard';
  if(t.includes('bankruptcy')) return 'bankruptcy';
  if(t.includes('lottery')) return 'lottery';
  if(t.includes('identity theft')) return 'idtheft';
  if(t.includes('extortion')) return 'extortion';
  return 'normal';
}
function shortLabel(text){
  const t=text.toLowerCase();
  if(t.includes('payday')) return 'PAYDAY';
  if(t.includes('tard card')) return 'TARD';
  if(t.includes('lottery')) return 'LOTTO';
  if(t.includes('bankruptcy')) return 'BANKRUPT';
  if(t.includes('identity theft')) return 'ID THEFT';
  if(t.includes('extortion')) return 'EXTORT';
  return text.length>22? text.slice(0,21)+'…':text;
}

connectWS();
</script>
</body>
</html>
